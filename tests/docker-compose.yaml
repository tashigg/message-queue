version: '3'

services:
  # All other brokers re-use the image built by this.
  broker1:
    container_name: broker1
    build:
      context: ../
      dockerfile: tests/Dockerfile
      ssh:
        - default
    image: message-queue-test
    volumes:
      - ./foxmq.d:/home/message-queue/foxmq.d
    ports:
      - "1883:1883"
      - "8883:8883"
    networks:
      mesh-app-bridge:
        aliases:
          - broker1.example.com
    environment: &broker_env
      RUST_LOG: tashi_consensus_engine=warn,foxmq=trace
    entrypoint: target/release/foxmq
    command: run --secret-key-file foxmq.d/key_0.pem --tls-cert-file=foxmq.d/key_0.crt --dns-name broker1.example.com /home/message-queue/foxmq.d

  broker2:
    container_name: broker2
    depends_on:
      - broker1
    image: message-queue-test
    volumes:
      - ./foxmq.d:/home/message-queue/foxmq.d
    ports:
      - "1884:1883"
      - "8884:8883"
    networks:
      mesh-app-bridge:
        aliases:
          - broker2.example.com
    environment: *broker_env
    entrypoint: target/release/foxmq
    command: run --secret-key-file foxmq.d/key_1.pem --tls-cert-file=foxmq.d/key_1.crt --dns-name broker2.example.com /home/message-queue/foxmq.d

networks:
  mesh-app-bridge:
    driver: bridge
    ipam:
      driver: default
      config:
        # Explicitly specify a subnet to use so we can reference it in the address book.
        - subnet: "172.16.238.0/24"
