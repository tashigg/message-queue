version: '3'

services:
  # All other brokers re-use the image built by this.
  broker1:
    container_name: broker1
    build:
      context: ../
      dockerfile: tests/Dockerfile
      ssh:
        - default
    image: foxmq-test
    volumes:
      - ./foxmq.d:/home/foxmq/foxmq.d
    ports:
      - "1883:1883"
      - "8080:8080"
      - "8883:8883"
    networks:
      mesh-app-bridge:
        aliases:
          - broker1.example.com
    environment: &broker_env
      RUST_LOG: tashi_consensus_engine=warn,foxmq=trace
    entrypoint: target/release/foxmq
    command: > # Folds newlines so we don't have to escape them in the command itself.
      run
      --mqtts
      --websockets
      --secret-key-file foxmq.d/key_0.pem
      --tls-cert-file=foxmq.d/key_0.crt
      --server-name broker1.example.com
      /home/foxmq/foxmq.d

  broker2:
    container_name: broker2
    depends_on:
      - broker1
    image: foxmq-test
    volumes:
      - ./foxmq.d:/home/foxmq/foxmq.d
    ports:
      - "1884:1883"
      - "8081:8080"
      - "8884:8883"
    networks:
      mesh-app-bridge:
        aliases:
          - broker2.example.com
    environment: *broker_env
    entrypoint: target/release/foxmq
    command: >
      run
      --mqtts
      --websockets
      --secret-key-file foxmq.d/key_1.pem
      --tls-cert-file=foxmq.d/key_1.crt
      --server-name broker2.example.com
      /home/foxmq/foxmq.d

networks:
  mesh-app-bridge:
    driver: bridge
    ipam:
      driver: default
      config:
        # Explicitly specify a subnet to use so we can reference it in the address book.
        # The 172.16.0.0â€“172.31.255.255 block is reserved for private networks.
        - subnet: "172.16.238.0/24"
